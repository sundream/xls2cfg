// auto generated by xls2cfg,do not edit!!!
using System;
using System.Collections.Generic;
using System.Reflection;

namespace {{namespace}} {
    public enum Format
    {
        Json,
        Binary
    }

    public sealed class Tables {
        public static Format format = Format.Json;
        public static Tables Instance = null;
        public delegate byte[] LoadFromFileCallback(string filename);
        private LoadFromFileCallback loadFromFile = null;

        public T Get<K,T>(Dictionary<K,T> tables, K key) {
            T? table = default(T);
            if (!tables.TryGetValue(key,out table)) {
                return default(T);
            }
            return table;
        }

        {% for sheet in sheets -%}
        {% if sheet.singleton -%}
        private {{sheet.className}} _{{sheet.instName}};
        public {{sheet.className}} {{sheet.instName}} {
            get {
                if (this._{{sheet.instName}} == null) {
                    this._{{sheet.instName}} = Tables.Deserialize<{{sheet.className}}>(this.loadFromFile("{{sheet.fileName}}"));
                }
                return this._{{sheet.instName}};
            }
        }
        {% else -%}
        private Dictionary<{{sheet.idTypename}}, {{sheet.className}}> _{{sheet.instName}};
        public Dictionary<{{sheet.idTypename}}, {{sheet.className}}> {{sheet.instName}} {
            get {
                if (this._{{sheet.instName}} == null) {
                    this._{{sheet.instName}} = Tables.DeserializeTable<{{sheet.idTypename}}, {{sheet.className}}>(this.loadFromFile("{{sheet.fileName}}"));
                }
                return this._{{sheet.instName}};
            }
        }
        {% endif -%}
        {% endfor %}

        private static T Deserialize<T>(byte[] data) {
            Type type = typeof(T);
            object obj = null;
            if (Tables.format == Format.Json) {
                var f = type.GetMethod("DeserializeFromJson",BindingFlags.Public | BindingFlags.Static);
                obj = f.Invoke(null,new object[] { data });
            }
            else {
                var f = type.GetMethod("DeserializeFromBinary",BindingFlags.Public | BindingFlags.Static);
                obj = f.Invoke(null, new object[] { data });
            }
            return (T)obj;
        }

        private static Dictionary<K, T> DeserializeTable<K, T>(byte[] data) {
            Type type = typeof(T);
            Dictionary<K, T> table;
            if (Tables.format == Format.Json) {
                var f = type.GetMethod("DeserializeTableFromJson",BindingFlags.Public | BindingFlags.Static);
                table = (Dictionary<K,T>)f.Invoke(null,new object[] {data });
            }
            else {
                var f = type.GetMethod("DeserializeTableFromBinary",BindingFlags.Public | BindingFlags.Static);
                table = (Dictionary<K,T>)f.Invoke(null, new object[] {data });
            }
            return table;
        }

        public Tables(LoadFromFileCallback loadFromFile) {
            this.loadFromFile = loadFromFile;
        }

        public void LoadAll(){
            var properties = this.GetType().GetProperties(BindingFlags.Public | BindingFlags.Instance | BindingFlags.GetProperty);
            Object obj = null;
            for (int i = 0; i < properties.Length; i++) {
                var prop = properties[i];
                obj = prop.GetValue(this, null);
            }
        }
    }
}